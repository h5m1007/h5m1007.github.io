---
title: docker
date: 2019-06-21 15:29:09
tags:
---

# dockerfile 和 docker-compose 的关系

背景是需要搭建个wordpress。

Q: 假如你不用 docker ，搭建 wordpress 怎么弄？
A: 先找台 server ，假设其 OS 为 Ubuntu ，然后按照文档一步步敲命令，写配置.

Q: 用 docker 呢？
A: 随便找台 server ，不管什么操作系统，只要支持 docker 就行，
执行终端命令 `docker run ubuntu`，docker 会从官方源里拉取最新的 Ubuntu 镜像，
可以认为你开了个 Ubuntu 虚拟机，然后一步步安装，跟上面一样。

BUT，但是这样安装有个显著的缺点，一旦 container (容器) 被删，你做的工作就都没了。
当然可以用命令`docker commit` 来保存成镜像，这样就可以复用了。

但是镜像一般比较大，而且只分享镜像的话，别人也不知道你这镜像到底包含什么，
这些问题都不利于分享和复用。一个直观的解决方案就是，写个脚本把安装过程全部记录下来，
这样再次安装的时候，执行脚本就行了。

而 Dockerfile 就是这样的脚本，它记录了一个镜像的制作过程。有了 *Dockerfile*, 只要执行
`docker build` ，就能制作镜像，而且 *Dockerfile* 就是文本文件，修改也很方便。

现在有了 wordpress 的镜像，只需要 docker run 就把 wordpress 启动起来了。

如果仅仅是 wordpress, 这也就够了。但是很多时候，需要多个镜像合作才能启动一个服务，
比如前端要有 nginx ，数据库 mysql , 邮件服务等等，当然你可以把所有这些都弄到一个镜像里去，
但这样做就无法复用了。更常见的是, nginx, mysql, smtp 都分别是个镜像，然后这些镜像合作，
共同服务一个项目。*docker-compose* 就是解决这个问题的。你的项目需要哪些镜像，每个镜像怎么
配置，要挂载哪些 volume, 等等信息都包含在 docker-compose.yml 里。要启动服务，
只需要执行命令 `docker-compose up` 就行，停止也只需要 `docker-compse stop/down`。

简而言之， *Dockerfile* 记录单个镜像的构建过程，*docker-compse.yml* 记录一个
项目(project, 一般是多个镜像)的构建过程。

至于结合使用 dockerfile+docker-compose, 是因为 *docker-compose.yml* 本身没有镜像
构建的信息，如果镜像是从 `docker registry` 拉取下来的，那么 *Dockerfile* 就不需要；
如果镜像是需要 build 的，那就需要提供 *Dockerfile*。

# Dockerfile、Docker镜像和 Docker容器的关系
[click](http://blog.csdn.net/zhousenshan/article/details/51501734)

# Dockerfile 详解
[click](http://blog.csdn.net/mozf881/article/details/55798811)

# 多进程管理工具 - Supervisor + Dockerfile
[click](https://www.linuxprobe.com/docker-process-management1.html)

# linux + docker + dockerfile + supervisor 终端命令回忆录

查看端口情况
`netstat -ntlp`

查看端口映射关系
`iptables -t nat -L -n`

端口映射 - linux
`iptables -t nat -A DOCKER -p tcp --dport 8001 -j DNAT --to-destination x.x.x.x:8000`

sudo docker run --detach \
  --hostname gitlab.example.com \
  --publish 443:443 --publish 88:80 --publish 23:22 \
  --name gitlab \
  --restart always \
  --volume /srv/gitlab/config:/etc/gitlab \
  --volume /srv/gitlab/logs:/var/log/gitlab \
  --volume /srv/gitlab/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest

关闭端口映射关系 (需要重启生效)
`iptables -A DOCKER -p tcp --dport 8001 -j DROP`

端口映射 - mac
`lsof -i -P | grep docke`
`sudo vim /etc/pf.anchors/eclipse.tomcat.forwarding`
`rdr pass on lo0 inet proto tcp from any to 127.0.0.1 port 3333 -> x.x.x.x port 3333`
`sudo pfctl -ef /etc/pf-tomcat.conf`

# 导致docker自启不了可能的原因
1. 宿主机自启服务的端口与容器自启服务端口有冲突

查看docker容器IP
`docker inspect auto_testing | grep IPAddress`

查看正在运行容器 & 查看所有包括停止的容器
`docker ps` & `docker ps -a`

启动已停止的容器
`docker start auto_testing`

进入容器并执行指定命令（Ctrl + P + Q 退出容器保持后台运行）
`docker exec -it auto_testing /bin/bash`

查看容器在它生命周期的记录
`docker logs auto_testing`
*注意事项* 当run容器后，启动不了容器，检查下log可发现问题

基于现有容器提交镜像至本地库
`docker commit -m="for auto testing" --author="xxx" auto_testing auto_testing/ubuntu:v1`

pull下来的镜像可能某些工具缺失
`apt-get update && \
apt-get install -y vim procps net-tools git
`

后台启动容器并指定端口映射
`docker run --restart=always --name auto_testing_v1 -d -p 8360:8360 -p 27018:27017 -p 9002:9001 auto_testing/ubuntu:v1 supervisord -n -c /etc/supervisord.conf`

`docker run --restart=always --privileged --name auto_testing \
-d -p 8360:8360 -p 27018:27017 -p 9002:9001 \
ubuntu/auto_testing:1.0 /bin/bash \
-c "while true;do echo hello world; sleep;done"`

`docker run --restart=always --privileged --name nginx-test-1 \
-d -p 80:80 nginx /bin/bash \
-c "while true;do echo hello world; sleep;done"
-v /pengzhiyang/nginx/conf.d:/etc/nginx/conf.d \
`

安装supervisor
`yum install python-setuptools`

生成supervisor配置文件模板
```
easy_install supervisor
echo_supervisord_conf > /etc/supervisord.conf
```

使用配置文件启用supervisor
`supervisord -c /etc/supervisord.conf`

查看运行进程
`supervisorctl status`

停用supervisor
`supervisorctl shutdown`

#auto_testing 容器已部署的模块

1. 系统ubuntu
2. git
3. node
4. mongo
安装路径：`/projects/mongodb`

配置环境变量
`vi /etc/profile`
末行位置新增
```
export MONGODB_HOME=/projects/mongodb
export PATH=/projects/mongodb/bin:$PATH
```

`vi /etc/rc.local`
配置开机启动服务(后台运行)：
```
/projects/mongodb/bin/mongod \
--fork --port 27017 \
--dbpath=/projects/mongodb/db \
--logpath=/projects/mongodb/logs/mongodb.log --logappend
```

取消占用
`rm -rf /projects/mongodb/db/mongod.lock`

查看进程占用
`netstat -ntpl`

强制杀掉占用进程
`kill -s 9 [pid]`

5. supervisor 进程控制管理


## docker里安装ubuntu，ubuntu里再安装docker

1. `docker pull ubuntu`
2. `docker run -it -d --privileged --name xxx ubuntu`
3. `docker exec -it xxx /bin/bash`
4. `apt-get update`
5.
```
apt-get -y install \
    apt-transport-https \
    ca-certificates \
    curl \
    software-properties-common \
    net-tools \
    iptables
```
6. `curl -fsSL get.docker.com -o get-docker.sh`
7. `sh get-docker.sh --mirror Aliyun`