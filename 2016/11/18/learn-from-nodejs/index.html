<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> NodeJs 全记录八 · Leooon Blog</title><meta name="description" content="NodeJs 全记录八 - Leon"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="google-site-verification" content="kx_a2Pxm8eUeXBh4VntVZ3IlkZpWcQMPjLgfTYpTLNI"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://h5m1007.github.io/atom.xml" title="Leooon Blog"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Leooon Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">NodeJs 全记录八</h1><div class="post-info">Nov 18, 2016</div><div class="post-content"><p>前端程序猿的第二春 使用老本行JS来构建服务器端的神器  NodeJs</p>
<h2 id="Socket-IO"><a href="#Socket-IO" class="headerlink" title="Socket.IO"></a>Socket.IO</h2><p>基于WebSocket出现的问题，Socket.IO在解决问题的同时保留了其API，也提供了良好的灵活性  </p>
<h3 id="兼容性高"><a href="#兼容性高" class="headerlink" title="兼容性高"></a>兼容性高</h3><p>Socket.IO的消息传递是<strong>基于传输</strong>的，并非全依靠WebSocket，可在大部分浏览器和设备上运行，包括IE6到IOS  </p>
<h3 id="可靠事件机制"><a href="#可靠事件机制" class="headerlink" title="可靠事件机制"></a>可靠事件机制</h3><p>提供对<strong>超时</strong>支持，监听 <code>connect</code> 和 <code>disconnect</code> 事件而不是 <code>open</code> 和 <code>close</code> 事件  </p>
<h3 id="Web通信方式"><a href="#Web通信方式" class="headerlink" title="Web通信方式"></a>Web通信方式</h3><p>典型通信方式经HTTP收发资源，而<strong>实时</strong>Web世界中，都是基于<strong>事件传输</strong>的  </p>
<p>Socket.IO通过分发 (<code>emit</code>) 和 监听 (<code>listen</code>) 来进行JSON数据收发  </p>
<p>WebSocket.IO方式  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    ws.on(&#39;connection&#39;, function(socket)&#123;</span><br><span class="line">        socket.on(&#39;message&#39;, function(msg)&#123;</span><br><span class="line">            &#x2F;&#x2F; deal with msg</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>Socket.IO方式  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    io.sockets.on(&#39;connection&#39;, function(socket)&#123;</span><br><span class="line">        socket.on(&#39;message&#39;, function(msg)&#123;</span><br><span class="line">            &#x2F;&#x2F; deal with msg</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><p>命名空间即多路传输，socket.io对同样的资源进行<strong>频道划分</strong>，并将数据传输给对应的回调，且允许监听多个命名空间的 <code>connection</code> 事件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    io.sockets.on(&#39;connection&#39;);</span><br><span class="line">    io.of(&#39;&#x2F;some&#x2F;namespace&#39;).on(&#39;connection&#39;);</span><br><span class="line">    io.of(&#39;&#x2F;some&#x2F;other&#x2F;namespace&#39;).on(&#39;connection&#39;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="实现实时聊天"><a href="#实现实时聊天" class="headerlink" title="实现实时聊天"></a>实现实时聊天</h3><ol>
<li>引入express和socket.io模块声明为 <code>sio</code></li>
<li>express创建服务并将返回对象 <code>app</code> 给 <code>sio</code> 监听</li>
<li>调用监听返回的全局对象 <code>io</code> 的 <code>sockets</code> 属性</li>
<li>用来监听 <code>connection</code>，回调带socket参数</li>
<li>该参数在连接后，用来监听客户端分发的 <code>join</code> 用户加入的事件</li>
<li>监听客户端分发的数据事件 <code>text</code></li>
<li>在 <code>join</code> 事件回调中，<code>broadcast.emit()</code> 给<strong>所有用户</strong>分发 <code>annoucement</code> 事件</li>
<li>在客户端调用全局对象的 <code>connect()</code> 方法</li>
<li>调用返回的对象 <code>socket</code> ，用来监听 <code>connect</code> 事件</li>
<li>监听后回调中，使用 <code>socket</code> 来分发 <code>emit</code> 事件和给回调的参数</li>
<li>当客户端有用户加入时，在 <code>connect</code> 回调中分发事件 <code>join</code></li>
<li>监听服务端分发的 <code>annoucement</code> 事件</li>
<li>当用户提交消息时，分发 <code>text</code> 事件和给回调的参数</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2018/10/15/node_support_es6/" class="prev">上一篇</a><a href="/2016/11/17/weixin_small_app/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2020 <a href="https://h5m1007.github.io">Leon</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>