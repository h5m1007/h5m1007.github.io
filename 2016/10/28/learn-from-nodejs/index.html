<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> NodeJs 全记录五 · Leooon Blog</title><meta name="description" content="NodeJs 全记录五 - Leon"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="google-site-verification" content="kx_a2Pxm8eUeXBh4VntVZ3IlkZpWcQMPjLgfTYpTLNI"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://h5m1007.github.io/atom.xml" title="Leooon Blog"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Leooon Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">NodeJs 全记录五</h1><div class="post-info">Oct 28, 2016</div><div class="post-content"><p>前端程序猿的第二春 使用老本行JS来构建服务器端的神器  NodeJs</p>
<h2 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h2><p>一个基于HTTP服务器的工具集，提供一种新的组织代码方式来与请求、响应对象进行交互，这种方式被称作中间件  </p>
<h3 id="static中间件"><a href="#static中间件" class="headerlink" title="static中间件"></a>static中间件</h3><ul>
<li>挂载<br>允许将任意url匹配到文件系统中任意目录  </li>
</ul>
<p>假设让 <code>/my-images</code> 这样的url和目录名为 <code>/images</code> 对应起来  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    var connect &#x3D; require(&#39;connect&#39;),</span><br><span class="line">        server &#x3D; connect.createServer();</span><br><span class="line">    server.use(</span><br><span class="line">        &#39;&#x2F;my-images&#39;,</span><br><span class="line">        connect.static(&#39;&#x2F;images&#39;)</span><br><span class="line">    );</span><br><span class="line">    server.listen(8080);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>maxAge<br>作为static的选项，实现限定资源在客户端的缓存时间  </li>
</ul>
<p>假设，客户端所有js合并至一个文件，在其文件名加上修订号，此时，设置选项maxAge可实现永缓存起来  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    server.use(</span><br><span class="line">        &#39;&#x2F;js&#39;,</span><br><span class="line">        connect.static(</span><br><span class="line">            &#39;&#x2F;path&#x2F;to&#x2F;bundles&#39;,</span><br><span class="line">            &#123; maxAge: 100000000&#125;</span><br><span class="line">        );</span><br><span class="line">    );</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="query中间件"><a href="#query中间件" class="headerlink" title="query中间件"></a>query中间件</h3><p>假设，客户端发送查询请求，url为 <code>/blog-posts?page=5</code> ，访问该url时，node会以字符串的形式将url存储至req.url中  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    server.use(connect.query);</span><br><span class="line">    server.use(function(req)&#123;</span><br><span class="line">        return req.url &#x3D;&#x3D; &quot;&#x2F;blog-posts?page&#x3D;5&quot;; &#x2F;&#x2F; true</span><br><span class="line">        return req.query.page &#x3D;&#x3D; &quot;5&quot;; &#x2F;&#x2F; true</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="logger中间件"><a href="#logger中间件" class="headerlink" title="logger中间件"></a>logger中间件</h3><p>用于对web应用诊断的工具，它将请求和响应信息打印在终端  </p>
<p>提供了四种日记格式：default、dev、short、tiny  </p>
<ul>
<li>connect.logger(‘dev’)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    server.createServer(</span><br><span class="line">        connect.logger(&#39;dev&#39;),</span><br><span class="line">        function(req, res)&#123;</span><br><span class="line">            res.writeHead(200);</span><br><span class="line">            res.end(&#39;Hello world&#39;);</span><br><span class="line">        &#125;</span><br><span class="line">    ).listen(8080);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>等价于初始化connect服务器时调用use两次  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    server.use(connect.logger(&#39;dev&#39;));</span><br><span class="line">    server.use(function(req, res, next)&#123;</span><br><span class="line">        res.writeHead(200);</span><br><span class="line">        res.end(&#39;Fast!&#39;);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>终端输出  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F; 200 0ms</span><br><span class="line">GET &#x2F;favicon.ico 200 2ms</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义格式</li>
</ul>
<p>记录<strong>请求</strong>方法和IP  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    server.use(</span><br><span class="line">        connect.logger(</span><br><span class="line">            &#39;:method :remote-addr&#39;</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>记录<strong>响应</strong>的content-length和content-type信息  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    server.use(</span><br><span class="line">        connect.logger(</span><br><span class="line">            &#39;type is :res[content-type], &#39; +</span><br><span class="line">            &#39;length is :res[content-length] &#39; +</span><br><span class="line">            &#39;and it took :response-time ms.&#39;</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="bodyparser中间件"><a href="#bodyparser中间件" class="headerlink" title="bodyparser中间件"></a>bodyparser中间件</h3><p>用来解析<strong>客户端请求body中的内容</strong>的中间件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;form action&#x3D;&quot;&#x2F;&quot; method&#x3D;&quot;POST&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;doc&quot;&gt;</span><br><span class="line">        &lt;button&gt;Send file!&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    &#x2F;&#x2F; 简写使用connect</span><br><span class="line">    &#x2F;&#x2F; 以下代码同时实现</span><br><span class="line">    &#x2F;&#x2F; 对connect.createServer()的使用</span><br><span class="line">    &#x2F;&#x2F; 和执行了4次的connect.createServer().use()</span><br><span class="line">    server &#x3D; connect(</span><br><span class="line">        connect.static(__dirname), &#x2F;&#x2F; 挂载当前执行js的目录</span><br><span class="line">        connect.bodyParser(), &#x2F;&#x2F; 使用解析中间件</span><br><span class="line">        connect.logger(&#39;dev&#39;),</span><br><span class="line">        function(req, res, next)&#123;</span><br><span class="line">            if(&#39;POST&#39; &#x3D;&#x3D; req.method)&#123;</span><br><span class="line">             &#x2F;&#x2F; 返回关联数组对象</span><br><span class="line">             &#x2F;&#x2F; 包含键为表单name值doc</span><br><span class="line">             &#x2F;&#x2F; 键doc值为上传文件的所有信息</span><br><span class="line">             console.log(req.files);</span><br><span class="line"></span><br><span class="line">             &#x2F;&#x2F; 返回对应表单name值为doc</span><br><span class="line">             &#x2F;&#x2F; 即上传文件的所有信息</span><br><span class="line">             console.log(req.files.doc);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">             next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ).listen(8080);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="cookieParser中间件"><a href="#cookieParser中间件" class="headerlink" title="cookieParser中间件"></a>cookieParser中间件</h3><p>便捷获取cookie数据，解析Cookies头可经  <code>req.cookies</code> 得到cookies  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Cookie: info1&#x3D;val1; info2&#x3D;val2</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    server.use(connect.cookieParser());</span><br><span class="line">    server.use(function(req, res, next)&#123;</span><br><span class="line">        &#x2F;&#x2F; req.cookies 得到存储cookie的对象</span><br><span class="line">        return req.cookies.info1 &#x3D;&#x3D; &#39;val1&#39;; &#x2F;&#x2F; true</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="session中间件"><a href="#session中间件" class="headerlink" title="session中间件"></a>session中间件</h3><p>会话中间件，多个请求间共享<em>用户会话</em>，类似于用户登录会有某种形式的会话系统，通过设置cookie来保存用户信息  </p>
<p><code>session(option)</code><br>接受参数option:  </p>
<p>| 1. key: Cookies名，默认值为connect.sid<br>| 2. store: session存储实例<br>| 3. secret: session的cookie加密<br>| 4. cookie: session的cookie配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    var connect &#x3D; require(&#39;connect&#39;),</span><br><span class="line">        users &#x3D; require(&#39;.&#x2F;users&#39;);</span><br><span class="line">    var server &#x3D; connect(</span><br><span class="line">        connect.logger(&#39;dev&#39;),</span><br><span class="line">        connect.bodyParser(),</span><br><span class="line">        &#x2F;&#x2F; 需要使用cookieParser中间件</span><br><span class="line">        &#x2F;&#x2F; 并且需放在session中间件前面</span><br><span class="line">        &#x2F;&#x2F; session的数据经加密后会保存到cookies中</span><br><span class="line">        connect.cookieParser(),</span><br><span class="line">        &#x2F;&#x2F; session默认存储方式存储到内存</span><br><span class="line">        &#x2F;&#x2F; 服务器关闭即进程关闭</span><br><span class="line">        &#x2F;&#x2F; session会丢失</span><br><span class="line">        connect.session(&#123;</span><br><span class="line">            secret: &#39;my app secret&#39;</span><br><span class="line">        &#125;),</span><br><span class="line">        function(req, res, next)&#123;</span><br><span class="line">            &#x2F;&#x2F; 登录后显示的内容</span><br><span class="line">            if(&#39;&#x2F;&#39; &#x3D;&#x3D; req.url &amp;&amp; req.session.logged_in)&#123;</span><br><span class="line">                &#x2F;&#x2F; req.session.logged_in</span><br><span class="line">                &#x2F;&#x2F; 判断登陆与否</span><br><span class="line">                res.writeHead(200, &#123;</span><br><span class="line">                    &quot;Content-Type&quot;: &quot;text&#x2F;html&quot;</span><br><span class="line">                &#125;);</span><br><span class="line">                res.end(</span><br><span class="line">                    &#39;Welcome back, &lt;b&gt;&#39; + req.session.name + &#39;&lt;&#x2F;b&gt;.&#39; +</span><br><span class="line">                    &#39;&lt;a href&#x3D;&quot;&#x2F;logout&quot;&gt;Logout&lt;&#x2F;a&gt;&#39;</span><br><span class="line">                );</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        function(req, res, next)&#123;</span><br><span class="line">            &#x2F;&#x2F; 登录页面内容</span><br><span class="line">            if(&#39;&#x2F;&#39; &#x3D;&#x3D; req.url &amp;&amp; &#39;GET&#39; &#x3D;&#x3D; req.method)&#123;</span><br><span class="line">                res.writeHead(200, &#123;</span><br><span class="line">                    &#39;Content-Type&#39;: &#39;text&#x2F;html&#39;</span><br><span class="line">                &#125;);</span><br><span class="line">                res.end([</span><br><span class="line">                    &#39;&lt;form action&#x3D;&quot;&#x2F;login&quot; method&#x3D;&quot;POST&quot;&gt;&#39;,</span><br><span class="line">                    &#39;&lt;fieldset&gt;&#39;,</span><br><span class="line">                    &#39;&lt;lengend&gt;Please log in&lt;&#x2F;lengend&gt;&#39;,</span><br><span class="line">                    &#39;&lt;p&gt;User: &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;user&quot; &#x2F;&gt;&lt;&#x2F;p&gt;&#39;,</span><br><span class="line">                    &#39;&lt;p&gt;Password: &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;password&quot; &#x2F;&gt;&lt;&#x2F;p&gt;&#39;,</span><br><span class="line">                    &#39;&lt;button&gt;Submit&lt;&#x2F;button&gt;&#39;,</span><br><span class="line">                    &#39;&lt;&#x2F;fieldset&gt;&#39;,</span><br><span class="line">                    &#39;&lt;&#x2F;form&gt;&#39;</span><br><span class="line">                ].join(&#39;&#39;));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        function(req, res, next)&#123;</span><br><span class="line">            if(&#39;&#x2F;login&#39; &#x3D;&#x3D; req.url &amp;&amp; &#39;POST&#39; &#x3D;&#x3D; req.method)&#123;</span><br><span class="line">                res.writeHead(200);</span><br><span class="line">                if(!users[req.body.user] || req.body.password !&#x3D; users[req.body.user].password)&#123;</span><br><span class="line">                    res.end(&#39;Bad username&#x2F;password&#39;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    req.session.logged_in &#x3D; true;</span><br><span class="line">                    req.session.name &#x3D; users[req.body.user].name;</span><br><span class="line">                    res.end(&#39;Authenticated!&#39;);</span><br><span class="line">                    console.log(JSON.stringify(req.session));</span><br><span class="line">                    console.log(JSON.stringify(req.cookies));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        function(req, res, next)&#123;</span><br><span class="line">            if(&#39;&#x2F;logout&#39; &#x3D;&#x3D; req.url)&#123;</span><br><span class="line">                req.session.logged_in &#x3D; false;</span><br><span class="line">                res.writeHead(200);</span><br><span class="line">                res.end(&#39;Logged out!&#39;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    server.listen(8080);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="basicAuth中间件"><a href="#basicAuth中间件" class="headerlink" title="basicAuth中间件"></a>basicAuth中间件</h3><p>向用户提供基本的身份验证  </p>
<p><code>connect.basicAuth(function(user,pass,fn))</code><br>提供user和pass直接指向用户输入的帐号和密码，fn回调来返回验证成功与否<br>当没有回调fn，将是同步验证，反之有fn回调则为异步验证  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    connect(</span><br><span class="line">        connect.basicAuth(function(user, pass, fn)&#123;</span><br><span class="line">            &#x2F;&#x2F; 实现客户端基本身份异步验证</span><br><span class="line">            process.stdout.write(&#39;Allow user \033[96m&#39; +</span><br><span class="line">                user +</span><br><span class="line">                &#39;\033[39m &#39; +</span><br><span class="line">                &#39;with pass \033[90m&#39; +</span><br><span class="line">                pass +</span><br><span class="line">                &#39;\03339m ? [y&#x2F;n]: &#39;);</span><br><span class="line">            process.stdin.once(&#39;data&#39;, function(data)&#123;</span><br><span class="line">                &#x2F;&#x2F; .once 每个请求获取一次数据</span><br><span class="line">                if(data[0] &#x3D;&#x3D; &#39;y&#39;)&#123;</span><br><span class="line">                    fn(null, &#123;</span><br><span class="line">                        username: user &#x2F;&#x2F; 用来生成req.remoteUser对象</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    fn(new Error(&#39;Unauthorized&#39;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;),</span><br><span class="line">        function(req, res)&#123;</span><br><span class="line">            res.writeHead(200);</span><br><span class="line">            res.end(&#39;Welcome to the protected area.&#39; +</span><br><span class="line">                &#x2F;&#x2F;req.remoteUser返回&#123; username: &#39;xxx&#39;&#125;</span><br><span class="line">                req.remoteUser.username);</span><br><span class="line">        &#125;</span><br><span class="line">    ).listen(8080);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a href="/2016/10/31/learn-from-nodejs/" class="prev">PREV</a><a href="/2016/10/23/learn-from-nodejs/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="https://h5m1007.github.io">Leon</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>